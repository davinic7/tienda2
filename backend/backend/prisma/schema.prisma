// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VENDEDOR
}

enum EstadoVenta {
  PENDIENTE
  COMPLETADA
  CANCELADA
}

enum MetodoPago {
  EFECTIVO
  CREDITO
  MIXTO
}

enum EstadoTurno {
  ABIERTO
  CERRADO
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  nombre    String
  role      Role
  localId   String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  local     Local?     @relation(fields: [localId], references: [id])
  ventas    Venta[]
  turnos    Turno[]
  auditLogs AuditLog[]

  @@index([email])
  @@index([localId])
}

model Local {
  id        String   @id @default(uuid())
  nombre    String
  direccion String?
  telefono  String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuarios User[]
  ventas   Venta[]
  stocks    Stock[]
  // precios   PrecioLocal[] // TODO: Descomentar después de ejecutar migración
  turnos    Turno[]

  @@index([activo])
}

model Producto {
  id            String   @id @default(uuid())
  nombre        String
  descripcion   String?
  precio        Decimal  @db.Decimal(10, 2) // Precio por defecto (para retrocompatibilidad)
  categoria     String?
  codigo_barras String?  @unique
  imagen_url    String?
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  stocks        Stock[]
  // precios       PrecioLocal[] // TODO: Descomentar después de ejecutar migración
  ventaDetalles VentaDetalle[]

  @@index([codigo_barras])
  @@index([categoria])
  @@index([activo])
}

model Stock {
  id           String   @id @default(uuid())
  productoId   String
  localId      String
  cantidad     Int      @default(0)
  stock_minimo Int      @default(10)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  producto Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  local    Local    @relation(fields: [localId], references: [id], onDelete: Cascade)

  @@unique([productoId, localId])
  @@index([localId])
  @@index([productoId])
}

// TODO: Descomentar después de ejecutar migración de Prisma
// model PrecioLocal {
//   id         String   @id @default(uuid())
//   productoId String
//   localId    String
//   precio     Decimal  @db.Decimal(10, 2)
//   createdAt  DateTime @default(now())
//   updatedAt  DateTime @updatedAt

//   producto Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
//   local    Local    @relation(fields: [localId], references: [id], onDelete: Cascade)

//   @@unique([productoId, localId])
//   @@index([localId])
//   @@index([productoId])
// }

model Cliente {
  id             String   @id @default(uuid())
  nombre         String
  dni            String?  @unique
  email          String?  @unique
  telefono       String?
  puntos         Int      @default(0)
  credito        Decimal  @default(0) @db.Decimal(10, 2)
  fecha_registro DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ventas Venta[]

  @@index([email])
  @@index([telefono])
  @@index([dni])
  @@index([nombre])
}

model Venta {
  id               String      @id @default(uuid())
  localId          String
  vendedorId       String
  clienteId        String?
  fecha            DateTime    @default(now())
  total            Decimal     @db.Decimal(10, 2)
  estado           EstadoVenta @default(COMPLETADA)
  metodoPago       MetodoPago  @default(EFECTIVO)
  creditoUsado     Decimal     @default(0) @db.Decimal(10, 2)
  efectivoRecibido Decimal?    @db.Decimal(10, 2)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  local    Local          @relation(fields: [localId], references: [id])
  vendedor User           @relation(fields: [vendedorId], references: [id])
  cliente  Cliente?       @relation(fields: [clienteId], references: [id])
  turno    Turno?         @relation(fields: [turnoId], references: [id])
  detalles VentaDetalle[]
  turnoId  String?

  @@index([localId])
  @@index([vendedorId])
  @@index([clienteId])
  @@index([fecha])
  @@index([estado])
  @@index([metodoPago])
  @@index([turnoId])
}

model VentaDetalle {
  id              String   @id @default(uuid())
  ventaId         String
  productoId      String
  cantidad        Int
  precio_unitario Decimal  @db.Decimal(10, 2)
  subtotal        Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  venta    Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  producto Producto @relation(fields: [productoId], references: [id])

  @@index([ventaId])
  @@index([productoId])
}

model Turno {
  id                String      @id @default(uuid())
  vendedorId        String
  localId           String
  fecha_apertura    DateTime    @default(now())
  fecha_cierre      DateTime?
  efectivo_inicial  Decimal     @db.Decimal(10, 2)
  efectivo_final    Decimal?    @db.Decimal(10, 2)
  efectivo_esperado Decimal?    @db.Decimal(10, 2)
  diferencia        Decimal?    @db.Decimal(10, 2)
  estado            EstadoTurno @default(ABIERTO)
  observaciones     String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  vendedor User    @relation(fields: [vendedorId], references: [id])
  local    Local   @relation(fields: [localId], references: [id])
  ventas   Venta[]

  @@index([vendedorId])
  @@index([localId])
  @@index([fecha_apertura])
  @@index([estado])
}

model AuditLog {
  id               String   @id @default(uuid())
  userId           String
  accion           String
  tabla            String
  fecha            DateTime @default(now())
  datos_anteriores Json?
  datos_nuevos     Json?
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([tabla])
  @@index([fecha])
}
